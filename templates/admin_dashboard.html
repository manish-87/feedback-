{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <h1>Admin Dashboard</h1>
    <a href="{{ url_for('admin_logout') }}" style="color: #667eea; text-decoration: none;">Logout</a>
</div>

<!-- Statistics -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;">
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px;">
        <div style="font-size: 32px; font-weight: bold;">{{ total_users }}</div>
        <div>Total Users</div>
    </div>
    <div style="background: #4CAF50; color: white; padding: 20px; border-radius: 8px;">
        <div style="font-size: 32px; font-weight: bold;">{{ users_with_feedback }}</div>
        <div>Feedback Submitted</div>
    </div>
    <div style="background: #ff9800; color: white; padding: 20px; border-radius: 8px;">
        <div style="font-size: 32px; font-weight: bold;">{{ users_without_feedback }}</div>
        <div>Pending Feedback</div>
    </div>
</div>

<!-- Add User Form -->
<div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
    <h2 style="margin-bottom: 15px; font-size: 20px;">Add New User</h2>
    <form id="addUserForm" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px;">
        <input type="text" id="userName" name="name" placeholder="Full Name" required>
        <input type="email" id="userEmail" name="email" placeholder="Email Address" required>
        <button type="submit" class="btn" style="width: auto; padding: 12px 20px;">Add User</button>
    </form>
    <div id="addUserMessage" style="margin-top: 10px;"></div>
</div>

<!-- Users List -->
<h2 style="margin-bottom: 20px;">Registered Users</h2>
<div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                <th style="padding: 12px; text-align: left;">Name</th>
                <th style="padding: 12px; text-align: left;">Email</th>
                <th style="padding: 12px; text-align: left;">Registered</th>
                <th style="padding: 12px; text-align: center;">Feedback</th>
                <th style="padding: 12px; text-align: center;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr style="border-bottom: 1px solid #e0e0e0;">
                <td style="padding: 12px;">{{ user.name }}</td>
                <td style="padding: 12px;">{{ user.email }}</td>
                <td style="padding: 12px; color: #666;">{{ user.registered_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td style="padding: 12px; text-align: center;">
                    {% if user.feedback_submitted %}
                        <span style="color: #4CAF50; font-weight: 600;">âœ“ Submitted</span>
                    {% else %}
                        <span style="color: #ff9800;">Pending</span>
                    {% endif %}
                </td>
                <td style="padding: 12px; text-align: center;">
                    {% if user.feedback_submitted %}
                        <a href="{{ url_for('view_user_feedback', user_id=user.id) }}" style="color: #667eea; text-decoration: none; padding: 6px 12px; border: 1px solid #667eea; border-radius: 4px; display: inline-block;">View Feedback</a>
                    {% else %}
                        <span style="color: #999;">No feedback yet</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .container {
        max-width: 1200px;
    }
</style>
<script>
    document.getElementById('addUserForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const messageDiv = document.getElementById('addUserMessage');
        messageDiv.innerHTML = '<div style="color: #666;">Adding user...</div>';
        
        try {
            const response = await fetch('{{ url_for("add_user") }}', {
                method: 'POST',
                body: formData
            });
            
            console.log('Add user response status:', response.status);
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Server error occurred' }));
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Add user response data:', data);
            
            if (data.success) {
                messageDiv.innerHTML = '<div class="success">' + data.message + '</div>';
                this.reset();
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                messageDiv.innerHTML = '<div class="error">' + (data.error || 'Failed to add user') + '</div>';
            }
        } catch (error) {
            console.error('Error adding user:', error);
            messageDiv.innerHTML = '<div class="error">Error: ' + error.message + '</div>';
        }
    });
</script>
{% endblock %}

